version: '3.8'

services:
  backend:
    container_name: nfc-v2-backend
    build:
      context: ../../
      dockerfile: deployment/docker/Dockerfile
    restart: unless-stopped
    working_dir: /var/www/backend
    volumes:
      - ../../backend:/var/www/backend
      - ./php.ini:/usr/local/etc/php/conf.d/app-php.ini
    environment:
      APP_NAME: 'Ritma DBC'
      APP_ENV: production
      APP_DEBUG: 'false'
      APP_URL: '${APP_URL:-http://45.127.6.225:8600}'
      # Session: leave unset for IP access (e.g. :8600). For HTTPS domain set in .env: SESSION_DOMAIN=.imritma.com SESSION_SECURE_COOKIE=true
      DB_CONNECTION: mysql
      DB_HOST: db
      DB_PORT: 3306
      DB_DATABASE: ritma_nfc_db
      DB_USERNAME: ritma_nfc_user
      DB_PASSWORD: ritma_nfc_password
      # CRM
      OCR_URL: 'https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent'
      OPENROUTER_API_KEY: '${OPENROUTER_API_KEY}'
    depends_on:
      - db

  nginx:
    container_name: nfc-v2-nginx
    image: nginx:alpine
    restart: unless-stopped
    ports:
      - "8600:80"
    volumes:
      - ./nginx.conf:/etc/nginx/conf.d/default.conf
      - ../../dist:/var/www/frontend
      - ../../backend:/var/www/backend
    depends_on:
      - backend

  db:
    container_name: nfc-v2-db
    image: mariadb:10.6
    restart: unless-stopped
    environment:
      MYSQL_DATABASE: ritma_nfc_db
      MYSQL_USER: ritma_nfc_user
      MYSQL_PASSWORD: ritma_nfc_password
      MYSQL_ROOT_PASSWORD: ritma_nfc_root_password
    volumes:
      - db_data:/var/lib/mysql

  phpmyadmin:
    container_name: nfc-v2-phpmyadmin
    image: phpmyadmin/phpmyadmin
    restart: unless-stopped
    ports:
      - "8601:80"
    environment:
      PMA_HOST: db
      PMA_PORT: 3306
    depends_on:
      - db

volumes:
  db_data:
